{% load bootstrap4 %}

<!DOCTYPE html>
<html>
    <head>
        {% bootstrap_css %}
        <style type="text/css">
            body {
                padding: 10px;
                margin: 10px;
            }
        </style>

        <!--Let browser know website is optimized for mobile-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a href="#" class="navbar-brand">VEGI Portfolio</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle Navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">Home</li>
                </ul>
            </div>
        </nav>

        {% bootstrap_messages %}

        <h1 class="display-3">{{latest_date}}</h1>
        <p>
            We are not responsible for any errors in or omissions related to this information, or for any consequences that may result from the use of this information. 
            This is here as a convience to the those that created it and is not a public service or recommendation.
            This is a live development environment: there will be errors and omissions.
        </p>

        <div class="container">
            <div class="row">
                <div class="col-md">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Prior Quarter</h5>
                            <p class="card-text">
                                <table class="table">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Quad</th>
                                            <th>Return</th>
                                            <th>σ</th>
                                            <th>Ratio</th>
                                        </tr>
                                    </thead>
                                    {% for quad, value in prior_quad_return.items %}
                                    <tr>
                                    <td>{{quad}}</td>
                                    {% for percent in value %}
                                        {% if forloop.first or forloop.last %}
                                            {% if percent < 0 %}                                        
                                        <td class="text-danger">
                                            {% elif percent > 0 %}
                                        <td class="text-success">
                                            {% else %}
                                        <td>
                                            {% endif %}
                                            {% else %}
                                        <td>
                                        {% endif %}
                                            {{percent}}
                                            {% if not forloop.last %}
                                            %
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </table>
                                <ul>
                                    <li>{{prior_quad_start}} - {{prior_quad_end}}</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Current Quarter</h5>
                            <p class="card-text">
                                <table class="table">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Quad</th>
                                            <th>Return</th>
                                            <th>σ</th>
                                            <th>Ratio</th>
                                        </tr>
                                    </thead>
                                    {% for quad, value in current_quad_return.items %}
                                    <tr>
                                        <td>{{quad}}</td>
                                        {% for percent in value %}
                                        {% if forloop.first or forloop.last %}
                                            {% if percent < 0 %}                                        
                                        <td class="text-danger">
                                            {% elif percent > 0 %}
                                        <td class="text-success">
                                            {% else %}
                                        <td>
                                            {% endif %}
                                            {% else %}
                                        <td>
                                        {% endif %}
                                            {{percent}}
                                            {% if not forloop.last %}
                                            %
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </table>
                                <ul>
                                    <li>{{current_quad_start}} - present</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Today</h5>
                            <p class="card-text">
                                <table class="table">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Quad</th>
                                            <th>Return</th>
                                        </tr>
                                    </thead>
                                    {% for quad, value in daily_return.items %}
                                    <tr>
                                        <td>{{quad}}</td>
                                        {% if value < 0 %}                                        
                                        <td class="text-danger">
                                        {% elif value > 0 %}
                                        <td class="text-success">
                                        {% endif %}
                                            {{value|floatformat:1}}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </table>
                                <ul>
                                    <li>{{latest_date}}</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-sm">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Quad Outlook</h5>
                            <p class="card-text">
                                <canvas id="quad_updates"></canvas>
                            </p>
                        </div>
                    </div>
                </div>            
            </div>
        </div>
            <div class="row">
                <div class="col-lg">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Commitment of Traders - Non-commercial Net Long Positioning - {{latest_cot_date}}</h5>
                            <p class="card-text">
                                <table class="table">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Security</th>
                                            <th>Net Long</th>
                                            <th>1-Year Ratio Δ Z-Score</th>
                                            <th>3-Year Ratio Δ Z-Score</th>
                                            <th>1-Year Abs. Z-Score</th>
                                            <th>3-Year Abs. Z-Score</th>
                                        </tr>
                                        {% for cot_value in cot_data %}
                                        <tr>
                                            <td>{{cot_value.symbol}}</td>
                                            {% if cot_value.net_long >= 0 %}
                                            <td class="text-success">
                                            {% else %}
                                            <td class="text-danger">
                                            {% endif %}
                                            {{cot_value.net_long|floatformat}}</td>
                                            {% if cot_value.one_year_z >= 2.0 or cot_value.one_year_z <= -2.0 %}
                                            <td class="alert-danger">
                                            {% else %}
                                            <td>
                                            {% endif %}
                                            {{cot_value.one_year_z|floatformat:2}}</td>
                                            {% if cot_value.three_year_z >= 2.0 or cot_value.three_year_z <= -2.0 %}
                                            <td class="alert-danger">
                                            {% else %}
                                            <td>
                                            {% endif %}
                                            {{cot_value.three_year_z|floatformat:2}}</td>
                                            {% if cot_value.one_year_abs_z >= 2.0 or cot_value.one_year_abs_z <= -2.0 %}
                                            <td class="alert-danger">
                                            {% else %}
                                            <td>
                                            {% endif %}
                                            {{cot_value.one_year_abs_z|floatformat:2}}</td>
                                            {% if cot_value.three_year_abs_z >= 2.0 or cot_value.three_year_abs_z <= -2.0 %}
                                            <td class="alert-danger">
                                            {% else %}
                                            <td>
                                            {% endif %}
                                            {{cot_value.three_year_abs_z|floatformat:2}}</td>                                            
                                        </tr>
                                        {% endfor %}
                                    </thead>
                                </table>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">{{data_updated}} EST</h5>
                            <p class="card-text">
                                <table class="table">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Price</th>
                                            <th data-toggle="tooltip" data-placement="top" title="(over {{lookback}} trading days)">Realized Daily Volatility</th>
                                            <th>1-σ Move</th>
                                        </tr>
                                    </thead>
                                    {% for symbol, value in symbol_values.items %}
                                    <tr>                                
                                        <td>{{symbol}}</td><td>${{value.0}}</td>
                                        {% if value.1 < 1.3 %}
                                        <td class="alert-success">{{value.1}}%</td>
                                        {% elif value.1 <= 1.8 %}
                                        <td class="alert-warning">{{value.1}}%</td>
                                        {% elif value.1 > 1.8 %}
                                        <td class="alert-danger">{{value.1}}%</td>
                                        {% else %}
                                        <td>{{value.1}}%</td>
                                        {% endif %}
                                        <td>${{value.2}}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <form action="/" method="POST" style="margin-top:2em;">
        <p class="lead">
            Current Equal-Volatility Allocations for $<input type="number" name="value" value="{{target_value}}"/> 
            <select name="currency">
                <option value="USD">USD</option>
                <option value="CAD">CAD</option>
            </select>
            <input type="submit" value=">" />
            {% csrf_token %}
        </p>
        </form> 
        <div class="row">
            {% for quad, value in quad_allocations.items %}
            <div class="col-sm">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Quad {{quad}}</h5>
                        <table class="table card-text">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Security</th>
                                    <th>Size</th>
                                </tr>
                            </thead>
                            {% for security, value in value.items %}
                            <tr>
                                <td>{{security}}</td><td>{{value}}</td>
                            </tr>
                            {% endfor %}
                        </table>    
                    </div>
                </div>
            </div> 
            {% endfor %}
        </div>

        <!--JavaScript at end of body for optimized loading-->
        {% bootstrap_javascript jquery='full' %}
        <script type="text/javascript">
            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })
        </script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.0/dist/Chart.min.js"></script>
        <script>
        var ctx = document.getElementById('quad_updates').getContext('2d');
        var scatterChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                {% for date, gdp_roc, cpi_roc in roc_data %}
                    {
                        label: "{{date}}",
                        
                        data: [
                            {
                                x: {{cpi_roc|floatformat}},
                                y: {{gdp_roc|floatformat}}
                            },
                        ],
                        {% if forloop.first %}
                        pointBackgroundColor: ['#00ff00'],
                        {% elif forloop.last %}
                        pointBackgroundColor: ['#0000ff'],
                        {% else %}
                        pointBackgroundColor: ['#00cbff'],
                        {% endif %}
                        {% if forloop.first %}
                        backgroundColor: '#00ff00'
                        {% elif forloop.last %}
                        backgroundColor: '#0000ff'
                        {% else %}
                        backgroundColor: '#00cbff'
                        {% endif %}
                    },
                {% endfor %}
                ]
            },
            options: {
                scales: {
                    xAxes: [{
                        type: 'linear',
                        position: 'bottom',
                        scaleLabel: {
                            labelString: "Inflation Velocity (bps)",
                            display: true
                        },
                        ticks: {
                            suggestedMax: 50.0,
                            suggestedMin: -50.0,
                            stepSize: 20.0,
                        }
                    }],
                    yAxes: [{
                        type: 'linear',
                        scaleLabel: {
                            labelString: "Growth Velocity (bps)",
                            display: true
                        },
                        ticks: {
                            suggestedMax: 50.0,
                            suggestedMin: -50.0,
                            stepSize: 20.0,
                        }
                    }]
                },
                legend: {
                    display: true,
                    position: 'right'
                }
            }
        });
        </script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id={{GOOGLE_ID}}"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '{{GOOGLE_ID}}');
        </script>
    </body>
</html>